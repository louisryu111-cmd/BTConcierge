<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Banyan Tree Busan Concierge</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root {
            --primary-color: #8E7958; /* Banyan Tree Gold */
            --bg-color: #121212;
            --card-bg: #1E1E1E;
            --text-color: #FFFFFF;
        }

        body {
            margin: 0; padding: 0; background-color: #000;
            font-family: 'Noto Sans KR', sans-serif;
            color: var(--text-color);
            -webkit-tap-highlight-color: transparent;
        }

        #app-container {
            max-width: 480px; margin: 0 auto; background-color: var(--bg-color);
            height: 100vh; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }

        .fade-in { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 1. ë¡œê·¸ì¸/ì¸ì¦ ì„ íƒ í™”ë©´ --- */
        #auth-selection-screen, #security-screen, #code-auth-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 1100; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .logo-intro {
            font-size: 22px; font-weight: 300; letter-spacing: 2px;
            margin-bottom: 50px; color: var(--primary-color); text-align: center; line-height: 1.5;
        }
        .auth-btn {
            width: 80%; background-color: var(--card-bg); color: #fff;
            border: 1px solid var(--primary-color); padding: 15px; border-radius: 10px;
            font-size: 16px; margin-bottom: 15px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-sizing: border-box;
        }
        .auth-btn:active { background-color: #333; }

        /* --- 2. ì•ˆë©´ì¸ì‹ ì¹´ë©”ë¼ í™”ë©´ --- */
        .camera-container {
            position: relative; width: 240px; height: 240px; border-radius: 50%;
            overflow: hidden; border: 2px solid var(--primary-color); margin-bottom: 20px;
            background: #1a1a1a; display: flex; align-items: center; justify-content: center;
        }
        #video-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: var(--primary-color); box-shadow: 0 0 15px var(--primary-color);
            animation: scan 2s infinite linear; display: none;
        }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        
        /* ë§¤ì¹˜ ê²°ê³¼ ì˜¤ë²„ë ˆì´ */
        #match-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1200; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .member-photo { width: 150px; height: 150px; border-radius: 50%; border: 3px solid var(--primary-color); object-fit: cover; margin-bottom: 20px; }
        .match-rate-text { font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .match-desc-text { font-size: 16px; color: var(--primary-color); margin-bottom: 30px; }

        /* --- 3. ì½”ë“œ ì…ë ¥ í™”ë©´ --- */
        .input-group {
            width: 80%; position: relative; display: flex; align-items: center;
            margin-bottom: 20px; box-sizing: border-box; z-index: 2000;
        }
        .code-input {
            width: 100%; background: #1a1a1a; border: 1px solid #444; color: #fff;
            padding: 15px 50px 15px 15px; font-size: 18px; border-radius: 10px;
            text-align: center; outline: none; box-sizing: border-box; pointer-events: auto;
        }
        .code-input:focus { border-color: var(--primary-color); }
        .voice-btn {
            position: absolute; right: 10px; color: var(--primary-color);
            cursor: pointer; background: none; border: none; padding: 5px;
        }
        .voice-btn.listening { color: #ff4444; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- 4. ë©”ì¸ í™”ë©´ --- */
        #main-app { display: none; flex: 1; flex-direction: column; padding: 25px 20px; overflow-y: auto; padding-bottom: 150px; }
        .hotel-name { font-size: 18px; font-weight: bold; color: var(--primary-color); margin-bottom: 20px; }
        .welcome-text { font-size: 20px; margin-bottom: 25px; line-height: 1.4; font-weight: 300; }
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .menu-item {
            background-color: var(--card-bg); border-radius: 12px; height: 110px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; border: 1px solid #333; transition: 0.2s; box-sizing: border-box;
        }
        .menu-item:active { background-color: #2a2a2a; border-color: var(--primary-color); }
        .menu-item i { font-size: 30px; color: var(--primary-color); margin-bottom: 10px; }
        .menu-item span { font-size: 13px; text-align: center; color: #ddd; font-weight: 500; line-height: 1.3; }

        /* --- 5. ì„œë¸Œ í™”ë©´ (ì»¨ì‹œì–´ì§€, í˜¸í…” ë“±) --- */
        .sub-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); z-index: 500; padding: 25px 20px;
            box-sizing: border-box; flex-direction: column; overflow-y: auto; padding-bottom: 100px;
        }
        .screen-header { display: flex; align-items: center; margin-bottom: 25px; font-size: 18px; font-weight: bold; color: var(--primary-color); }
        .screen-header i { margin-right: 15px; cursor: pointer; }

        /* --- í•˜ë‹¨ ë°” (Map ì „ìš©) & ì €ì‘ê¶Œ --- */
        .bottom-area {
            position: absolute; bottom: 0; left: 0; width: 100%; background-color: #0a0a0a;
            border-top: 1px solid #222; z-index: 100; display: none; flex-direction: column; align-items: center; padding: 15px 0 20px 0;
        }
        .map-btn {
            display: flex; flex-direction: column; align-items: center; color: var(--primary-color);
            cursor: pointer; margin-bottom: 15px;
        }
        .map-btn i { font-size: 28px; margin-bottom: 5px; }
        .map-btn span { font-size: 12px; font-weight: bold; }
        
        .copyright { font-size: 10px; color: #666; text-align: center; line-height: 1.5; padding: 0 10px; }

        /* ë°”í…€ ì‹œíŠ¸ (íˆ¬ì–´ ë“±) */
        #bottom-sheet-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1200; }
        #bottom-sheet { position: absolute; bottom: -100%; left: 0; width: 100%; background-color: #1a1a1a; border-radius: 20px 20px 0 0; z-index: 1201; transition: bottom 0.3s ease; padding: 20px; box-sizing: border-box; }
        .sub-list-item { padding: 18px 0; border-bottom: 1px solid #2a2a2a; display: flex; justify-content: space-between; color: #ddd; cursor: pointer; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="auth-selection-screen">
        <div class="logo-intro">BANYAN TREE<br><span style="font-size:14px; color:#aaa;">BUSAN HAEUNDAE</span></div>
        <button class="auth-btn" onclick="initFaceID()"><i class="material-icons">face_retouching_natural</i>ì•ˆë©´ì¸ì‹ ë¡œê·¸ì¸</button>
        <button class="auth-btn" onclick="openCodeAuth()"><i class="material-icons">password</i>ì¸ì¦ ì½”ë“œë¡œ ë¡œê·¸ì¸</button>
    </div>

    <div id="security-screen">
        <div class="logo-intro" id="face-title">FACE ID VERIFICATION</div>
        <div class="camera-container">
            <i class="material-icons" id="camera-icon" style="font-size:60px; color:#555;">face</i>
            <video id="video-feed" playsinline muted></video>
            <div class="scan-line" id="scan-bar"></div>
        </div>
        <div id="face-status" style="color:var(--primary-color); margin-bottom:20px; text-align:center; font-size:14px;">ì¹´ë©”ë¼ ëª¨ë“ˆ ë¡œë“œ ì¤‘...<br>(HTTPS í™˜ê²½ í•„ìš”)</div>
        <button class="auth-btn" style="width:50%; font-size:14px; background:none; border-color:#555; color:#aaa;" onclick="location.reload()">ëŒì•„ê°€ê¸°</button>
        
        <div id="match-overlay">
            <img id="member-photo" src="https://via.placeholder.com/150/111111/8E7958?text=Member" class="member-photo">
            <div class="match-rate-text" id="match-rate-text"></div>
            <div class="match-desc-text" id="match-desc-text"></div>
            <button id="match-action-btn" class="auth-btn" style="width:auto; padding: 10px 30px;" onclick="handleMatchAction()">í™•ì¸</button>
        </div>
    </div>

    <div id="code-auth-screen">
        <div class="logo-intro">MEMBER ACCESS</div>
        <div class="input-group">
            <input type="text" id="access-code" class="code-input" placeholder="">
            <button class="voice-btn" onclick="startVoiceRecognition('access-code')"><i class="material-icons">mic</i></button>
        </div>
        <button class="auth-btn" onclick="verifyCode()" style="background:var(--primary-color)">ë¡œê·¸ì¸</button>
        <div style="margin-top:20px; color:#666; font-size:13px; cursor:pointer; text-decoration:underline;" onclick="location.reload()">ë’¤ë¡œ ê°€ê¸°</div>
    </div>

    <div id="main-app">
        <div class="hotel-name">Banyantree Busan Haeundae</div>
        <div class="welcome-text">ë°˜ê°‘ìŠµë‹ˆë‹¤, íšŒì›ë‹˜.<br><b>ì–´ë–¤ ì„œë¹„ìŠ¤ë¥¼ ë„ì™€ë“œë¦´ê¹Œìš”?</b></div>
        
        <div class="menu-grid">
            <div class="menu-item" onclick="showSubScreen('concierge')"><i class="material-icons">room_service</i><span>Concierge<br>Service</span></div>
            <div class="menu-item" onclick="showSubScreen('hotel')"><i class="material-icons">apartment</i><span>Hotel<br>Service</span></div>
            <div class="menu-item" onclick="window.open('https://www.banyantree.com/booking', '_blank')"><i class="material-icons">event_available</i><span>Member<br>Booking</span></div>
            <div class="menu-item" onclick="checkLocationForValet()"><i class="material-icons">directions_car</i><span>Valet<br>Parking</span></div>
        </div>
    </div>

    <div id="concierge-screen" class="sub-screen fade-in">
        <div class="screen-header"><i class="material-icons" onclick="closeSubScreen()">arrow_back</i>Concierge Service</div>
        <div class="menu-grid">
            <div class="menu-item" onclick="openTourSheet()"><i class="material-icons">map</i><span>4 Season Tour</span></div>
            <div class="menu-item" onclick="alert('Kids ì„œë¹„ìŠ¤ ì¤€ë¹„ ì¤‘')"><i class="material-icons">child_friendly</i><span>Kids</span></div>
            <div class="menu-item" onclick="alert('ì„¸ì°¨ ì˜ˆì•½ ì„œë¹„ìŠ¤')"><i class="material-icons">local_car_wash</i><span>Car Wash</span></div>
            <div class="menu-item" onclick="alert('ì¸ê·¼ ê±°ì  ë³‘ì› ì •ë³´ë¥¼ ì•ˆë‚´í•©ë‹ˆë‹¤.')"><i class="material-icons">medical_services</i><span>Hospital<br>Information</span></div>
        </div>
    </div>

    <div id="hotel-screen" class="sub-screen fade-in">
        <div class="screen-header"><i class="material-icons" onclick="closeSubScreen()">arrow_back</i>Hotel Service</div>
        <div class="menu-grid">
            <div class="menu-item" onclick="alert('Dining ì˜ˆì•½ í˜ì´ì§€ ì—°ê²° ì˜ˆì •')"><i class="material-icons">restaurant</i><span>Dining</span></div>
            <div class="menu-item" onclick="alert('Lounge ì•ˆë‚´ í˜ì´ì§€ ì—°ê²° ì˜ˆì •')"><i class="material-icons">local_bar</i><span>Lounge</span></div>
            <div class="menu-item" onclick="alert('Wellness ì•ˆë‚´ í˜ì´ì§€ ì—°ê²° ì˜ˆì •')"><i class="material-icons">spa</i><span>Wellness</span></div>
            <div class="menu-item" onclick="alert('Facilities ì•ˆë‚´ í˜ì´ì§€ ì—°ê²° ì˜ˆì •')"><i class="material-icons">pool</i><span>Facilities</span></div>
            <div class="menu-item" onclick="alert('í˜¸í…” ë‚´ Kids í”„ë¡œê·¸ë¨ ì˜ˆì•½ í˜ì´ì§€ ì—°ê²° ì˜ˆì •')"><i class="material-icons">child_care</i><span>Kids</span></div>
            <div class="menu-item" onclick="alert('ì—°íšŒì¥ ë° ì›¨ë”© ìƒë‹´ í˜ì´ì§€ ì—°ê²° ì˜ˆì •')"><i class="material-icons">celebration</i><span>ì—°íšŒì¥ ë° ì›¨ë”©</span></div>
        </div>
    </div>

    <div id="valet-screen" class="sub-screen fade-in">
        <div class="screen-header"><i class="material-icons" onclick="closeSubScreen()">arrow_back</i>Valet Service</div>
        <div style="text-align:center; margin-bottom:30px; font-size:13px; color:#aaa; line-height:1.6; background:#2a251a; padding:15px; border:1px solid var(--primary-color); border-radius:10px;">
            â€œë³¸ ì„œë¹„ìŠ¤ëŠ” ë°œë › ì¶œì°¨ ì „ìš©ì´ë©°,<br>í˜¸í…” ë‚´ ì²´ë¥˜ ì‹œì—ë§Œ ìš”ì²­ ê°€ëŠ¥í•©ë‹ˆë‹¤.â€
        </div>
        <div class="input-group" style="width:100%;">
            <input type="text" id="car-number" class="code-input" placeholder="ì°¨ëŸ‰ë²ˆí˜¸ ì…ë ¥ (ì˜ˆ: 12ê°€ 3456)">
            <button class="voice-btn" onclick="startVoiceRecognition('car-number')"><i class="material-icons">mic</i></button>
        </div>
        <button class="auth-btn" style="width:100%; background:var(--primary-color);" onclick="sendValetDuve()">ì¶œì°¨ ìš”ì²­í•˜ê¸°</button>
    </div>

    <div class="bottom-area" id="bottom-area">
        <div class="map-btn" onclick="window.open('https://drive.google.com/file/d/1ICKC21t37n6B5ek9WQc_NNsLAfjAFfMo/view?usp=drive_link', '_blank')">
            <i class="material-icons">map</i>
            <span>Residences Map</span>
        </div>
        <div class="copyright">
            Â© Banyan Tree Hotels & Resorts.<br>All rights reserved.
        </div>
    </div>

    <div id="bottom-sheet-overlay" onclick="closeSheet()"></div>
    <div id="bottom-sheet">
        <div class="sheet-header" style="border-bottom:1px solid #333; padding-bottom:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <span style="color:var(--primary-color); font-weight:bold; font-size:18px;">4 Season Tour</span>
            <i class="material-icons" style="color:#aaa; cursor:pointer;" onclick="closeSheet()">close</i>
        </div>
        <div id="sheet-content">
            <div class="sub-list-item" onclick="window.open('https://drive.google.com/file/d/1Ax4O2b49CM5I6-KnMebXjz9r8PHlgUmz/view')"><span>ğŸŒ¸ Spring Course</span><i class="material-icons">open_in_new</i></div>
            <div class="sub-list-item" onclick="window.open('https://drive.google.com/file/d/1m1nqU2eRtS4YHKAPKqYEekQn7KF0i_sp/view')"><span>ğŸŒŠ Summer Course</span><i class="material-icons">open_in_new</i></div>
            <div class="sub-list-item" onclick="window.open('https://drive.google.com/file/d/1d84lGgWJuSJUh3F-AJThTIq-B-t9usRd/view')"><span>ğŸ‚ Autumn Course</span><i class="material-icons">open_in_new</i></div>
            <div class="sub-list-item" onclick="window.open('https://drive.google.com/file/d/1YpcJG6XhzOfaR_e0iDOY0y2yXt5f0t8S/view')"><span>â„ï¸ Winter Course</span><i class="material-icons">open_in_new</i></div>
        </div>
    </div>
</div>

<script>
    // ========================================================
    // [ì¸ì¦ ë° ì‹œìŠ¤í…œ ë³€ìˆ˜]
    // ========================================================
    // ì¹´ì¹´ì˜¤í†¡(ë°œë ›) ì—°ê²°
    const DUVE_CHAT_URL = "https://wa.me/821050280073"; 
    // í˜¸í…” ìœ„ì¹˜ (ë‹¬ë§ì´ ë§¥ë„ë‚ ë“œ 1km ë°˜ê²½ ì ìš©)
    const TARGET_LAT = 35.1618;  
    const TARGET_LNG = 129.1709; 
    
    let isLoginSuccessful = false;
    let faceDetectionInterval;
    let cameraStream = null;

    // 1. í…ìŠ¤íŠ¸ ì½”ë“œ ì¸ì¦ (ìš”ì²­í•˜ì‹  4ê°€ì§€ ì½”ë“œ ë°˜ì˜)
    function openCodeAuth() {
        document.getElementById('auth-selection-screen').style.display = 'none';
        document.getElementById('code-auth-screen').style.display = 'flex';
        // ì…ë ¥ì°½ ìë™ í¬ì»¤ìŠ¤
        setTimeout(() => document.getElementById('access-code').focus(), 100);
    }

    function verifyCode() {
        const validCodes = ["foryou", "for you", "í¬ìœ ", "í¬ ìœ "];
        const input = document.getElementById('access-code').value.trim().toLowerCase();
        
        if (validCodes.includes(input)) {
            loginSuccess();
        } else {
            alert("ì½”ë“œ ì˜¤ë¥˜ì…ë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.");
            document.getElementById('access-code').value = '';
        }
    }

    // 2. ìŒì„± ì¸ì‹ (STT) ê¸°ëŠ¥
    function startVoiceRecognition(targetId) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("í˜„ì¬ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome, Safari ìµœì‹ ë²„ì „ ê¶Œì¥)");
            return;
        }
        const recognition = new SpeechRecognition();
        recognition.lang = 'ko-KR';
        const btn = event.currentTarget;
        
        btn.classList.add('listening');
        recognition.start();

        recognition.onresult = (e) => {
            document.getElementById(targetId).value = e.results[0][0].transcript;
        };
        recognition.onend = () => btn.classList.remove('listening');
        recognition.onerror = () => btn.classList.remove('listening');
    }

    // 3. ì•ˆë©´ ì¸ì‹ ë¡œì§ (ë§¤ì¹˜ìœ¨ 62% ì´ìƒ ê°ì§€ ì‹œ ì§„í–‰)
    async function initFaceID() {
        document.getElementById('auth-selection-screen').style.display = 'none';
        document.getElementById('security-screen').style.display = 'flex';
        const status = document.getElementById('face-status');
        
        try {
            // face-api.js ëª¨ë¸ ë¡œë“œ (ì™¸ë¶€ CDN ì‚¬ìš©)
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
            ]);
            startCameraFeed();
        } catch (e) {
            status.innerText = "ì¹´ë©”ë¼ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì½”ë“œ ë¡œê·¸ì¸ì„ ì´ìš©í•´ ì£¼ì„¸ìš”.";
            console.error(e);
        }
    }

    async function startCameraFeed() {
        const video = document.getElementById('video-feed');
        const status = document.getElementById('face-status');
        const scanBar = document.getElementById('scan-bar');
        const camIcon = document.getElementById('camera-icon');

        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            video.srcObject = cameraStream;
            camIcon.style.display = 'none';
            video.style.display = 'block';
            scanBar.style.display = 'block';
            
            video.onplay = () => {
                status.innerText = "ì •ë©´ì„ ì‘ì‹œí•´ ì£¼ì„¸ìš”...";
                
                // ì£¼ê¸°ì ìœ¼ë¡œ ì–¼êµ´ ê°ì§€
                faceDetectionInterval = setInterval(async () => {
                    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
                    
                    if (detections.length > 0) {
                        clearInterval(faceDetectionInterval);
                        scanBar.style.display = 'none';
                        
                        // ì‹¤ì œ ì‹œì—°ì„ ìœ„í•´ ëœë¤ ë§¤ì¹˜ìœ¨ ìƒì„± (62% ~ 90% ì‚¬ì´)
                        // (ì‹¤ë¬´ì—ì„œëŠ” ë“±ë¡ëœ ì–¼êµ´ ë°ì´í„° descriptorê°„ì˜ ìœ í´ë¦¬ë“œ ê±°ë¦¬ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤.)
                        const simulatedRate = Math.floor(Math.random() * 29) + 62; 
                        
                        // êµ¬ê¸€ ì‹œíŠ¸ ëŒ€ì¡° ì‹œë®¬ë ˆì´ì…˜ ë¬¸êµ¬
                        status.innerText = "êµ¬ê¸€ ì„œë²„ ë°ì´í„°ì™€ ëŒ€ì¡° ì¤‘ì…ë‹ˆë‹¤...";
                        
                        setTimeout(() => {
                            if (simulatedRate >= 70) {
                                // 70% ì´ìƒ: ìœ ë ¥í•¨ -> ë¡œê·¸ì¸ í—ˆìš©
                                showMatchOverlay(70, "ìœ ë ¥í•¨", true);
                            } else if (simulatedRate >= 62) {
                                // 62% ~ 69%: 60% ì¶”ì •ë¨ -> ë¡œê·¸ì¸ ë¶ˆê°€
                                showMatchOverlay(60, "ì¶”ì •ë¨", false);
                            }
                        }, 1500);
                    }
                }, 1000);
            };
        } catch (err) {
            status.innerText = "ì¹´ë©”ë¼ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì—ˆê±°ë‚˜ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
        }
    }

    function showMatchOverlay(rate, desc, isSuccess) {
        document.getElementById('match-overlay').style.display = 'flex';
        document.getElementById('match-rate-text').innerText = `ë§¤ì¹˜ìœ¨ ${rate}%`;
        document.getElementById('match-desc-text').innerText = desc;
        
        const btn = document.getElementById('match-action-btn');
        if (isSuccess) {
            isLoginSuccessful = true;
            btn.innerText = "ì ‘ì†í•˜ê¸°";
            btn.style.backgroundColor = "var(--primary-color)";
        } else {
            isLoginSuccessful = false;
            btn.innerText = "ë‹¤ì‹œ ì‹œë„";
            btn.style.backgroundColor = "#555";
        }
    }

    function handleMatchAction() {
        document.getElementById('match-overlay').style.display = 'none';
        if (isLoginSuccessful) {
            loginSuccess();
        } else {
            // ì‹¤íŒ¨ ì‹œ ë‹¤ì‹œ ìŠ¤ìº” ì‹œì‘
            document.getElementById('scan-bar').style.display = 'block';
            document.getElementById('face-status').innerText = "ë‹¤ì‹œ ì •ë©´ì„ ì‘ì‹œí•´ ì£¼ì„¸ìš”...";
            startCameraFeed();
        }
    }

    // 4. ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
    function loginSuccess() {
        document.getElementById('auth-selection-screen').style.display = 'none';
        document.getElementById('security-screen').style.display = 'none';
        document.getElementById('code-auth-screen').style.display = 'none';
        
        document.getElementById('main-app').style.display = 'flex';
        document.getElementById('bottom-area').style.display = 'flex';
        
        // ì¹´ë©”ë¼ ë„ê¸°
        if(cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
    }

    // 5. í™”ë©´ ë„¤ë¹„ê²Œì´ì…˜ ì œì–´
    function showSubScreen(type) {
        document.getElementById('main-app').style.display = 'none';
        document.querySelectorAll('.sub-screen').forEach(s => s.style.display = 'none');
        document.getElementById(type + '-screen').style.display = 'flex';
    }

    function closeSubScreen() {
        document.querySelectorAll('.sub-screen').forEach(s => s.style.display = 'none');
        document.getElementById('main-app').style.display = 'flex';
    }

    // 6. ìœ„ì¹˜ ê¸°ë°˜ ë°œë › í™•ì¸
    function checkLocationForValet() {
        if (!navigator.geolocation) {
            alert("ì´ ê¸°ê¸°ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        // ë¸Œë¼ìš°ì € ê¶Œí•œ íŒì—… í˜¸ì¶œ
        navigator.geolocation.getCurrentPosition((pos) => {
            const latDiff = pos.coords.latitude - TARGET_LAT;
            const lngDiff = pos.coords.longitude - TARGET_LNG;
            const dist = Math.sqrt(Math.pow(latDiff, 2) + Math.pow(lngDiff, 2));
            
            // 0.009 = ì•½ 1km
            if (dist < 0.009) {
                showSubScreen('valet');
            } else {
                alert("ë³¸ ì„œë¹„ìŠ¤ëŠ” ë°œë › ì¶œì°¨ë§Œ ê°€ëŠ¥í•˜ë©°, ê·€í•˜ì˜ ìœ„ì¹˜ê°€ ë°˜ì–€íŠ¸ë¦¬ ë¶€ì‚° í•´ìš´ëŒ€ í˜¸í…” ë‚´ì— ê³„ì‹¤ ë•Œ ì„œë¹„ìŠ¤ê°€ ì§„í–‰ë©ë‹ˆë‹¤.");
            }
        }, (err) => {
            alert("ë³¸ ì„œë¹„ìŠ¤ëŠ” ë°œë › ì¶œì°¨ë§Œ ê°€ëŠ¥í•˜ë©°, ê·€í•˜ì˜ ìœ„ì¹˜ê°€ ë°˜ì–€íŠ¸ë¦¬ ë¶€ì‚° í•´ìš´ëŒ€ í˜¸í…” ë‚´ì— ê³„ì‹¤ ë•Œ ì„œë¹„ìŠ¤ê°€ ì§„í–‰ë©ë‹ˆë‹¤.");
        }, { enableHighAccuracy: true });
    }

    function sendValetDuve() {
        const carNum = document.getElementById('car-number').value.trim();
        if (!carNum) return alert("ì°¨ëŸ‰ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        const msg = encodeURIComponent(`[ë°œë › ì¶œì°¨ ìš”ì²­] ì°¨ëŸ‰ë²ˆí˜¸: ${carNum}`);
        window.open(`${DUVE_CHAT_URL}?text=${msg}`, '_blank');
        document.getElementById('car-number').value = '';
    }

    // 7. ë°”í…€ ì‹œíŠ¸ (4 Season Tour)
    function openTourSheet() {
        document.getElementById('bottom-sheet-overlay').style.display = 'block';
        setTimeout(() => document.getElementById('bottom-sheet').style.bottom = '0', 10);
    }
    function closeSheet() {
        document.getElementById('bottom-sheet').style.bottom = '-100%';
        setTimeout(() => document.getElementById('bottom-sheet-overlay').style.display = 'none', 300);
    }
</script>
</body>
</html>