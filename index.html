<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>실전형 모바일 안면 인식 (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow-x: hidden; }
        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 3/4;
            background: #000;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        #webcam, #overlay-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
        }
        .mirror { transform: scaleX(-1); }
        .scanning-bar {
            position: absolute;
            width: 100%; height: 4px;
            background: linear-gradient(to bottom, transparent, #3b82f6, transparent);
            box-shadow: 0 0 20px #3b82f6;
            z-index: 20;
            top: 0;
            animation: scan 2s infinite linear;
            display: none;
        }
        @keyframes scan {
            0% { top: 0%; }
            100% { top: 100%; }
        }
    </style>
</head>
<body class="bg-slate-950 text-white min-h-screen flex flex-col">

    <header class="p-6 bg-slate-900/50 backdrop-blur-xl border-b border-white/10">
        <div class="flex justify-between items-end">
            <div>
                <p class="text-blue-400 text-xs font-bold tracking-widest uppercase">System v2.1 (CORS Fix)</p>
                <h1 class="text-2xl font-black">AI Face Scanner</h1>
            </div>
            <div id="status-dot" class="flex items-center gap-2 text-[10px] text-slate-400">
                <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                SYSTEM INIT...
            </div>
        </div>
    </header>

    <main class="flex-1 p-4 space-y-6 max-w-md mx-auto w-full">
        <div class="video-container border border-white/10">
            <video id="webcam" autoplay playsinline muted></video>
            <canvas id="overlay-canvas"></canvas>
            <div id="scanner" class="scanning-bar"></div>
            
            <div id="ui-overlay" class="absolute inset-0 z-30 bg-slate-900 flex flex-col items-center justify-center p-8 text-center transition-opacity duration-500">
                <div id="main-loader" class="w-10 h-10 border-2 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <h3 id="overlay-title" class="text-lg font-bold">시스템 초기화 중</h3>
                <p id="overlay-desc" class="text-xs text-slate-400 mt-2 max-w-[200px]">AI 모델 로드 및 클라우드 데이터 동기화를 진행합니다.</p>
                <button id="retry-btn" class="hidden mt-6 px-6 py-2 bg-white text-black rounded-full font-bold text-sm">새로고침</button>
            </div>
        </div>

        <div class="flex gap-3">
            <button id="start-btn" disabled class="flex-1 bg-blue-600 disabled:bg-slate-800 disabled:text-slate-500 py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition-all">
                카메라 켜기
            </button>
            <button id="switch-btn" class="w-16 bg-slate-800 rounded-2xl flex items-center justify-center active:scale-95 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>
        </div>

        <div id="result-panel" class="bg-white/5 rounded-3xl p-6 border border-white/10 hidden">
            <div class="flex items-center gap-5">
                <div class="relative">
                    <img id="db-photo" src="" class="w-20 h-20 rounded-2xl object-cover bg-slate-800 border-2 border-blue-500/50" crossorigin="anonymous">
                    <div class="absolute -bottom-2 -right-2 bg-blue-500 rounded-full p-1.5">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                </div>
                <div>
                    <h2 id="user-name" class="text-2xl font-bold">---</h2>
                    <p id="user-dept" class="text-blue-400 text-sm font-medium tracking-wide italic">---</p>
                    <p id="user-id" class="text-[10px] text-slate-500 mt-1 font-mono uppercase tracking-tighter">ID: ---</p>
                </div>
            </div>
        </div>

        <div class="bg-black/40 rounded-2xl p-4 border border-white/5">
            <div class="flex justify-between items-center mb-2">
                <span class="text-[10px] text-slate-400 font-bold">SYSTEM LOG</span>
                <span id="log-count" class="text-[9px] bg-slate-800 px-1.5 py-0.5 rounded text-slate-400">0</span>
            </div>
            <div id="log" class="text-[10px] font-mono text-slate-400 h-24 overflow-y-auto space-y-1 custom-scrollbar">
                <div class="text-blue-400">> Booting System...</div>
            </div>
        </div>
    </main>

    <script>
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1Nm-cjEZS-Ob-1FDMItiCxHVes4Yknkep/export?format=csv";
        
        let labeledDescriptors = []; 
        let faceMatcher = null;
        let isProcessing = false;
        let currentFacingMode = 'user';
        let logCounter = 0;

        const video = document.getElementById('webcam');
        const canvas = document.getElementById('overlay-canvas');
        const logEl = document.getElementById('log');

        function addLog(m, type = 'info') {
            logCounter++;
            document.getElementById('log-count').textContent = logCounter;
            
            const d = document.createElement('div');
            d.textContent = `> ${m}`;
            if (type === 'error') d.classList.add('text-red-400');
            else if (type === 'success') d.classList.add('text-green-400');
            
            logEl.appendChild(d);
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function initAI() {
            try {
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL) // 더 정확한 모델 추가 로드
                ]);
                addLog("AI Models Loaded Successfully.", 'success');
                loadCloudData();
            } catch (err) {
                addLog("AI Model Fail: " + err.message, 'error');
                showError("AI 모델 로드 실패", "네트워크 연결을 확인하세요.");
            }
        }

        async function loadCloudData() {
            try {
                addLog("Connecting to Google Sheets...");
                const res = await fetch(SHEET_CSV_URL);
                const data = await res.text();
                const rows = data.split('\n').slice(1);
                
                const users = rows.map(r => {
                    const cols = r.split(',').map(c => c.trim());
                    // 데이터가 없는 행 건너뛰기
                    if (!cols[0]) return null;
                    return {
                        id: cols[0],
                        name: cols[1],
                        dept: cols[2],
                        photoUrl: cols[3]
                    };
                }).filter(u => u && u.photoUrl);

                addLog(`Found ${users.length} users. Analyzing photos...`);

                let successCount = 0;
                labeledDescriptors = await Promise.all(users.map(async user => {
                    try {
                        // CORS 우회 프록시 사용 (필수)
                        let targetUrl = user.photoUrl;
                        
                        // 구글 드라이브나 일반 HTTP 링크의 경우 프록시 경유
                        const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(targetUrl);
                        
                        // 이미지 로드 시도
                        const img = await faceapi.fetchImage(proxyUrl);
                        
                        // 얼굴 감지 (정확도 높은 모델 사용)
                        const fullDesc = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                        
                        if (fullDesc) {
                            successCount++;
                            addLog(`OK: ${user.name}`, 'success');
                            return new faceapi.LabeledFaceDescriptors(
                                `${user.name}|${user.dept}|${user.id}|${user.photoUrl}`, 
                                [fullDesc.descriptor]
                            );
                        } else {
                            addLog(`Fail: ${user.name} (No Face Found)`, 'error');
                            return null;
                        }
                    } catch (e) {
                        addLog(`Fail: ${user.name} (Load Error)`, 'error');
                        console.error(e);
                        return null;
                    }
                }));

                labeledDescriptors = labeledDescriptors.filter(d => d !== null);
                
                if (labeledDescriptors.length > 0) {
                    faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.55); // 엄격도 조절
                    
                    document.getElementById('ui-overlay').classList.add('hidden');
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('status-dot').innerHTML = '<span class="w-2 h-2 bg-emerald-500 rounded-full"></span> READY';
                    addLog(`System Ready. (${successCount}/${users.length} loaded)`, 'success');
                } else {
                    showError("데이터 로드 실패", "인식 가능한 얼굴 사진이 없습니다. 로그를 확인하세요.");
                }
            } catch (err) {
                addLog("Sheet Error: " + err.message, 'error');
                showError("시트 연동 실패", "구글 시트 링크나 권한을 확인하세요.");
            }
        }

        async function startCamera() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentFacingMode, width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = stream;
                video.classList.toggle('mirror', currentFacingMode === 'user');
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    document.getElementById('scanner').style.display = 'block';
                    document.getElementById('start-btn').textContent = "스캔 중...";
                    runFaceDetection();
                };
            } catch (err) {
                alert("카메라 권한이 필요합니다.");
            }
        }

        async function runFaceDetection() {
            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                // 모바일 성능 고려하여 TinyFaceDetector 사용
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptors();
                
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                resizedDetections.forEach(d => {
                    const bestMatch = faceMatcher.findBestMatch(d.descriptor);
                    const box = d.detection.box;
                    
                    // 신뢰도 임계값 체크
                    const label = bestMatch.toString();
                    const isUnknown = label.includes('unknown');

                    const drawBox = new faceapi.draw.DrawBox(box, { 
                        label: isUnknown ? "Unknown" : label.split('|')[0], 
                        boxColor: isUnknown ? 'red' : '#3b82f6' 
                    });
                    drawBox.draw(canvas);

                    if (!isUnknown) {
                        showResult(bestMatch.label);
                    }
                });
            }, 500);
        }

        function showResult(labelData) {
            const [name, dept, id, url] = labelData.split('|');
            const panel = document.getElementById('result-panel');
            
            // 이미 같은 사람이 떠있으면 갱신 안함 (깜빡임 방지)
            if (!panel.classList.contains('hidden') && document.getElementById('user-name').textContent === name) return;

            panel.classList.remove('hidden');
            document.getElementById('user-name').textContent = name;
            document.getElementById('user-dept').textContent = dept;
            document.getElementById('user-id').textContent = `ID: ${id}`;
            document.getElementById('db-photo').src = url;
            
            // 성공 로그
            addLog(`Matched: ${name}`, 'success');
        }

        function showError(title, desc) {
            document.getElementById('overlay-title').textContent = title;
            document.getElementById('overlay-desc').textContent = desc;
            document.getElementById('main-loader').classList.add('hidden');
            document.getElementById('retry-btn').classList.remove('hidden');
            document.getElementById('overlay-title').classList.add('text-red-500');
        }

        document.getElementById('start-btn').addEventListener('click', startCamera);
        document.getElementById('switch-btn').addEventListener('click', () => {
            currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
            startCamera();
        });
        document.getElementById('retry-btn').addEventListener('click', () => location.reload());

        window.onload = initAI;
    </script>
</body>
</html>