<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Banyan Tree Busan</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary-color: #8E7958; --bg-color: #121212; --text-color: #FFFFFF; }
        body { margin: 0; background: #000; font-family: 'Noto Sans KR', sans-serif; color: var(--text-color); overflow: hidden; }
        #app-container { max-width: 480px; margin: 0 auto; background: var(--bg-color); height: 100vh; position: relative; }
        #auth-overlay { position: absolute; inset: 0; z-index: 2000; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .camera-container { position: relative; width: 260px; height: 260px; border-radius: 50%; overflow: hidden; border: 2px solid var(--primary-color); margin-bottom: 20px; }
        #video-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .auth-btn { width: 80%; background: #1e1e1e; color: #fff; border: 1px solid var(--primary-color); padding: 18px; border-radius: 12px; font-size: 16px; margin-bottom: 10px; cursor: pointer; }
        
        /* 실시간 상태 로그 창 */
        #debug-log { position: absolute; bottom: 20px; width: 90%; background: rgba(0,0,0,0.8); color: #0f0; font-size: 10px; padding: 10px; border-radius: 5px; max-height: 100px; overflow-y: auto; font-family: monospace; pointer-events: none; }
        
        #main-app { display: none; padding: 25px; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-item { background: #1e1e1e; border-radius: 15px; height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #333; }
        #match-popup { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="auth-overlay">
        <div id="auth-main">
            <h2 style="text-align:center; color:var(--primary-color);">BANYAN TREE</h2>
            <button class="auth-btn" onclick="startFaceAuth()">안면인식 시작</button>
            <button class="auth-btn" onclick="document.getElementById('auth-overlay').style.display='none'; document.getElementById('main-app').style.display='block';">코드 입장 (테스트용)</button>
        </div>

        <div id="auth-face" style="display:none; text-align:center;">
            <div class="camera-container">
                <video id="video-feed" playsinline muted></video>
            </div>
            <div id="face-status" style="margin-bottom:10px;">데이터 분석 중...</div>
            <div id="debug-log"></div>
        </div>
    </div>

    <div id="main-app">
        <h3 style="color:var(--primary-color)">CONCIERGE</h3>
        <div class="menu-grid">
            <div class="menu-item"><span>4 Season Tour</span></div>
            <div class="menu-item"><span>Hotel Service</span></div>
            <div class="menu-item"><span>Dining</span></div>
            <div class="menu-item"><span>Valet</span></div>
        </div>
    </div>

    <div id="match-popup">
        <div id="match-name" style="font-size:24px; margin-bottom:20px;"></div>
        <button class="auth-btn" style="width:150px;" onclick="location.reload()">확인</button>
    </div>
</div>

<script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRjdw6b40uOKNdnSDIL0Hmz_5wiRsJV6WznPvR_fNAmneePy-JcE6DIlC5E_Asdhb-jGeh_01VzR8H-/pub?output=csv";
    let faceMatcher = null;

    function log(msg) {
        const div = document.getElementById('debug-log');
        div.innerHTML += `> ${msg}<br>`;
        div.scrollTop = div.scrollHeight;
    }

    // 구글 드라이브 차단을 우회하는 가장 강력한 이미지 프록시 적용
    function getSafeImageUrl(url) {
        if (!url) return "";
        let id = "";
        if (url.includes('id=')) id = url.split('id=')[1].split('&')[0];
        else if (url.includes('/d/')) id = url.split('/d/')[1].split('/')[0];
        
        if (id) {
            const rawDriveUrl = `https://docs.google.com/uc?export=view&id=${id}`;
            // weserv.nl 프록시: 구글의 차단을 피하고 이미지를 분석 가능하게 변환함
            return `https://images.weserv.nl/?url=${encodeURIComponent(rawDriveUrl)}&default=${encodeURIComponent(rawDriveUrl)}`;
        }
        return url;
    }

    async function startFaceAuth() {
        document.getElementById('auth-main').style.display = 'none';
        document.getElementById('auth-face').style.display = 'block';
        
        try {
            log("모델 로드 중...");
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
            
            log("카메라 연결 중...");
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            document.getElementById('video-feed').srcObject = stream;

            loadSheetData();
        } catch (e) { log("초기화 실패: " + e.message); }
    }

    async function loadSheetData() {
        try {
            log("시트 데이터 가져오는 중...");
            const res = await fetch(SHEET_URL + "&t=" + new Date().getTime());
            const data = await res.text();
            const rows = data.split('\n').slice(1);
            const labeled = [];

            for (let row of rows) {
                const cols = row.split(',');
                if (cols.length < 2) continue;
                
                const name = cols[0].trim().replace(/"/g, '');
                const url = cols[1].trim().replace(/"/g, '');
                if (!name || !url) continue;

                log(`${name}님 이미지 분석 중...`);
                const safeUrl = getSafeImageUrl(url);

                try {
                    const img = await faceapi.fetchImage(safeUrl);
                    const det = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    if (det) {
                        labeled.push(new faceapi.LabeledFaceDescriptors(name, [det.descriptor]));
                        log(`OK: ${name}님 등록 완료`);
                    } else {
                        log(`Fail: ${name}님 얼굴 인식 불가`);
                    }
                } catch (e) { log(`Error: ${name}님 사진 로드 실패`); }
            }

            if (labeled.length === 0) throw new Error("분석된 얼굴 데이터 없음");
            
            faceMatcher = new faceapi.FaceMatcher(labeled, 0.6);
            document.getElementById('face-status').innerText = "인식 준비 완료! 카메라를 보세요.";
            detectFace();
        } catch (e) {
            log("연동 최종 실패: " + e.message);
            document.getElementById('face-status').innerHTML = "연동 실패. 시트와 사진 권한을 확인하세요.";
        }
    }

    async function detectFace() {
        const video = document.getElementById('video-feed');
        setInterval(async () => {
            if (!faceMatcher) return;
            const det = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
            if (det.length > 0) {
                const match = faceMatcher.findBestMatch(det[0].descriptor);
                if (match.distance < 0.4) { // 매치 성공 시
                    document.getElementById('match-popup').style.display = 'flex';
                    document.getElementById('match-name').innerText = `${match.label}님 환영합니다!`;
                    faceMatcher = null; // 중복 방지
                    setTimeout(() => {
                        document.getElementById('auth-overlay').style.display = 'none';
                        document.getElementById('main-app').style.display = 'block';
                    }, 1500);
                }
            }
        }, 1000);
    }
</script>
</body>
</html>