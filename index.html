<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Authorized Face ID</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #020617; color: white; }
        .video-wrapper { position: relative; width: 100%; aspect-ratio: 3/4; border-radius: 2rem; overflow: hidden; background: #000; }
        #webcam, #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .mirror { transform: scaleX(-1); }
        .log-box::-webkit-scrollbar { width: 4px; }
        .log-box::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 4px; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="p-6 border-b border-white/5 bg-slate-900/50 backdrop-blur-md">
        <h1 class="text-xl font-bold flex items-center gap-2">
            <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
            Security Gate
        </h1>
    </header>

    <main class="flex-1 p-5 max-w-md mx-auto w-full space-y-6">
        
        <!-- Login Panel -->
        <div id="login-panel" class="bg-slate-900 border border-white/10 rounded-[2.5rem] p-8 text-center space-y-6 shadow-2xl">
            <div class="mx-auto w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center text-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
            </div>
            <div>
                <h2 class="text-xl font-bold">인증이 필요합니다</h2>
                <p class="text-sm text-slate-400 mt-2">구글 시트 및 드라이브의 비공개 데이터를 읽기 위해 로그인이 필요합니다.</p>
            </div>
            <button id="btn-login" class="w-full bg-white text-black font-bold py-4 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-all">
                <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" class="w-5 h-5">
                Google 계정으로 로그인
            </button>
        </div>

        <!-- Main App Panel -->
        <div id="app-panel" class="hidden space-y-6">
            <div class="video-wrapper border border-white/10">
                <video id="webcam" autoplay playsinline muted></video>
                <canvas id="overlay"></canvas>
                <div id="loading-overlay" class="absolute inset-0 bg-slate-900 flex flex-col items-center justify-center p-10 text-center">
                    <div class="w-10 h-10 border-2 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p class="text-sm font-medium">데이터 동기화 중...</p>
                    <p id="sync-status" class="text-[10px] text-slate-500 mt-2 italic">AI 모델 로드 중</p>
                </div>
            </div>

            <div class="flex gap-3">
                <button id="btn-start" disabled class="flex-1 bg-blue-600 disabled:bg-slate-800 disabled:text-slate-500 py-4 rounded-2xl font-bold active:scale-95 transition-all">
                    카메라 켜기
                </button>
            </div>

            <!-- Recognition Result -->
            <div id="result-box" class="hidden bg-white/5 border border-white/10 rounded-3xl p-6">
                <div class="flex items-center gap-5">
                    <img id="user-img" src="" class="w-20 h-20 rounded-2xl object-cover bg-slate-800 border border-blue-500/30">
                    <div>
                        <div id="user-name" class="text-2xl font-black">---</div>
                        <div id="user-dept" class="text-blue-400 text-sm">---</div>
                        <div id="user-id" class="text-[10px] text-slate-500 mt-1 font-mono">ID: ---</div>
                    </div>
                </div>
            </div>

            <!-- Log Console -->
            <div class="bg-black/40 rounded-2xl p-4 border border-white/5">
                <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">System Logs</div>
                <div id="console" class="log-box h-32 overflow-y-auto text-[10px] font-mono text-slate-400 space-y-1">
                    <div>> System Ready. Waiting for Auth.</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // [설정 정보]
        const CLIENT_ID = '88725170403-lkp5homgvhjv50ffoadde8u43sfr8dba.apps.googleusercontent.com'; // 반드시 본인의 클라이언트 ID로 교체하세요
        const SPREADSHEET_ID = '1Nm-cjEZS-Ob-1FDMItiCxHVes4Yknkep';
        const SHEET_NAME = 'sheet1'; // 시트 탭 이름이 정확한지 확인하세요

        let accessToken = null;
        let tokenClient;
        let faceMatcher = null;

        const consoleEl = document.getElementById('console');
        function printLog(msg, type = 'info') {
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            if (type === 'error') div.className = 'text-red-400';
            if (type === 'success') div.className = 'text-emerald-400';
            consoleEl.appendChild(div);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        window.onload = () => {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/drive.readonly',
                callback: async (res) => {
                    if (res.error) return printLog("인증 에러: " + res.error, 'error');
                    accessToken = res.access_token;
                    document.getElementById('login-panel').style.display = 'none';
                    document.getElementById('app-panel').classList.remove('hidden');
                    printLog("로그인 인증 성공.", 'success');
                    await startSync();
                }
            });
        };

        document.getElementById('btn-login').onclick = () => tokenClient.requestAccessToken();

        async function startSync() {
            try {
                // 1. AI 모델 로드
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                printLog("AI 엔진 준비 완료.");

                // 2. 구글 시트 호출 (URL 인코딩 강화)
                document.getElementById('sync-status').textContent = "시트 데이터 읽는 중...";
                const encodedSheetName = encodeURIComponent(SHEET_NAME);
                const sheetUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodedSheetName}?majorDimension=ROWS`;
                
                printLog("데이터 요청 중: " + SHEET_NAME);
                const sheetRes = await fetch(sheetUrl, { 
                    headers: { Authorization: `Bearer ${accessToken}` } 
                });

                if (!sheetRes.ok) {
                    const errorDetail = await sheetRes.json();
                    console.error(errorDetail);
                    throw new Error(`시트 접근 실패 (${sheetRes.status}): ${errorDetail.error.message}`);
                }
                
                const data = await sheetRes.json();
                if (!data.values || data.values.length < 2) throw new Error("시트에 데이터가 비어있습니다.");
                
                const users = data.values.slice(1).map(row => ({
                    id: row[0], name: row[1], dept: row[2], url: row[3]
                })).filter(u => u.url && u.name);

                printLog(`${users.length}명의 사용자 확인. 이미지 학습 시작...`);
                await buildFaceMatcher(users);

            } catch (err) {
                printLog("오류 발생: " + err.message, 'error');
                // 상세 에러 힌트
                if (err.message.includes("400")) printLog("힌트: 시트 이름이 '" + SHEET_NAME + "'이 맞는지 확인하세요.", "info");
            }
        }

        async function buildFaceMatcher(users) {
            const descriptors = await Promise.all(users.map(async user => {
                try {
                    let imageSource;
                    if (user.url.includes("drive.google.com")) {
                        // 드라이브 파일 ID 추출 정규식 강화
                        const fileIdMatch = user.url.match(/[-\w]{25,}/);
                        if (!fileIdMatch) throw new Error("ID 추출 불가");
                        
                        const fileId = fileIdMatch[0];
                        const driveUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
                        
                        const imgRes = await fetch(driveUrl, { headers: { Authorization: `Bearer ${accessToken}` } });
                        if (!imgRes.ok) throw new Error("파일 접근 권한 없음");
                        
                        const blob = await imgRes.blob();
                        imageSource = await faceapi.bufferToImage(blob);
                    } else {
                        imageSource = await faceapi.fetchImage(`https://wsrv.nl/?url=${encodeURIComponent(user.url)}&output=jpg`);
                    }

                    const detection = await faceapi.detectSingleFace(imageSource, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    
                    if (detection) {
                        printLog(`${user.name} 학습 성공`, 'success');
                        const label = `${user.name}|${user.dept}|${user.id}|${user.url}`;
                        return new faceapi.LabeledFaceDescriptors(label, [detection.descriptor]);
                    }
                } catch (e) {
                    printLog(`${user.name} 건너뜀: ${e.message}`, 'error');
                }
                return null;
            }));

            const validDescriptors = descriptors.filter(d => d !== null);
            if (validDescriptors.length === 0) throw new Error("학습된 얼굴 데이터가 없습니다.");

            faceMatcher = new faceapi.FaceMatcher(validDescriptors, 0.55);
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('btn-start').disabled = false;
            printLog("시스템 가동 준비 완료.", 'success');
        }

        // 카메라 및 인식 로직은 기존과 동일... (중략)
        async function startCamera() {
            const video = document.getElementById('webcam');
            const canvas = document.getElementById('overlay');
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const displaySize = { width: video.videoWidth, height: video.videoHeight };
                faceapi.matchDimensions(canvas, displaySize);
                
                setInterval(async () => {
                    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
                    const resized = faceapi.resizeResults(detections, displaySize);
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                    resized.forEach(d => {
                        const match = faceMatcher.findBestMatch(d.descriptor);
                        const isUnknown = match.label.includes('unknown');
                        new faceapi.draw.DrawBox(d.detection.box, { 
                            label: isUnknown ? "Unknown" : match.label.split('|')[0],
                            boxColor: isUnknown ? '#ef4444' : '#3b82f6'
                        }).draw(canvas);
                        if (!isUnknown) {
                            const [name, dept, id, url] = match.label.split('|');
                            document.getElementById('result-box').classList.remove('hidden');
                            document.getElementById('user-name').textContent = name;
                            document.getElementById('user-dept').textContent = dept;
                            document.getElementById('user-id').textContent = `ID: ${id}`;
                            const fileId = url.match(/[-\w]{25,}/);
                            document.getElementById('user-img').src = fileId ? `https://lh3.googleusercontent.com/u/0/d/${fileId[0]}` : url;
                        }
                    });
                }, 600);
            };
        }
        document.getElementById('btn-start').onclick = startCamera;
    </script>
</body>
</html>